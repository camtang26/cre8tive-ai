id: pattern-nextjs-ssr-safe-gsap-2025
name: "Next.js 15 SSR-Safe GSAP Initialization"
category: "nextjs-patterns"
complexity: "medium"
gsap_version: "3.13.0+"
plugins_required: []
premium_plugins_free: false
is_2025_standard: true
react_19_compatible: true
nextjs_15_compatible: true
nextjs_app_router: true
description: "Properly initialize GSAP in Next.js 15 App Router to avoid SSR hydration errors. Uses 'use client' directive, useLayoutEffect for immediate DOM access, and proper plugin registration. Essential foundation for all Next.js GSAP work."
inspiration_source: "GSAP Official React Documentation + Next.js Best Practices"
source_url: "https://gsap.com/resources/React/"
source_citation: "Archon MCP: gsap.com official docs (source_id: 6a6860cfc96e173b) + Next.js 15 patterns"
performance_notes: "useLayoutEffect fires before browser paint, preventing flicker. Plugin registration happens once per component mount."
accessibility_notes: "Check prefers-reduced-motion in useLayoutEffect for SSR safety"
code_example: |
  'use client'; // CRITICAL: Must be client component for GSAP

  import { useRef, useLayoutEffect } from 'react';
  import gsap from 'gsap';
  import { useGSAP } from '@gsap/react';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  // Register plugins OUTSIDE component (runs once)
  if (typeof window !== 'undefined') {
    gsap.registerPlugin(useGSAP, ScrollTrigger);
  }

  export default function AnimatedSection() {
    const container = useRef();

    // useLayoutEffect for immediate DOM access (before paint)
    useLayoutEffect(() => {
      // Double-check we're in browser (Next.js safety)
      if (typeof window === 'undefined') return;

      // Check accessibility
      const prefersReducedMotion = window.matchMedia(
        '(prefers-reduced-motion: reduce)'
      ).matches;

      if (prefersReducedMotion) {
        // Set final state without animation
        gsap.set('.animated-element', { opacity: 1, y: 0 });
        return;
      }

      // Safe to animate now
      const ctx = gsap.context(() => {
        gsap.from('.animated-element', {
          opacity: 0,
          y: 50,
          duration: 1,
          stagger: 0.2
        });
      }, container);

      // Cleanup on unmount
      return () => ctx.revert();
    }, []); // Empty deps = run once on mount

    return (
      <section ref={container}>
        <div className="animated-element">Element 1</div>
        <div className="animated-element">Element 2</div>
        <div className="animated-element">Element 3</div>
      </section>
    );
  }

usegsap_hook_version: |
  'use client';

  import { useRef } from 'react';
  import gsap from 'gsap';
  import { useGSAP } from '@gsap/react';

  gsap.registerPlugin(useGSAP);

  export default function AnimatedSection() {
    const container = useRef();

    // useGSAP handles SSR safety automatically
    useGSAP(
      () => {
        const prefersReducedMotion = window.matchMedia(
          '(prefers-reduced-motion: reduce)'
        ).matches;

        if (prefersReducedMotion) {
          gsap.set('.animated-element', { opacity: 1, y: 0 });
          return;
        }

        gsap.from('.animated-element', {
          opacity: 0,
          y: 50,
          duration: 1,
          stagger: 0.2
        });
      },
      { scope: container } // Auto-cleanup on unmount
    );

    return (
      <section ref={container}>
        <div className="animated-element">Element 1</div>
        <div className="animated-element">Element 2</div>
      </section>
    );
  }

common_errors_to_avoid: |
  // ❌ WRONG: No 'use client' directive
  import gsap from 'gsap';
  export default function Component() {
    gsap.to('.element', { x: 100 }); // ERROR: window is undefined
  }

  // ❌ WRONG: Using useEffect instead of useLayoutEffect
  useEffect(() => {
    gsap.from('.element', { opacity: 0 }); // FLICKER: visible before animation
  }, []);

  // ❌ WRONG: Registering plugins inside component
  export default function Component() {
    gsap.registerPlugin(ScrollTrigger); // Runs on every render!
    // ...
  }

  // ✅ CORRECT: All issues fixed
  'use client';

  import { useLayoutEffect } from 'react';
  import gsap from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  if (typeof window !== 'undefined') {
    gsap.registerPlugin(ScrollTrigger); // Once per app
  }

  export default function Component() {
    useLayoutEffect(() => {
      if (typeof window === 'undefined') return;
      gsap.from('.element', { opacity: 0 }); // No flicker
    }, []);

    return <div className="element">Content</div>;
  }

server_component_alternative: |
  // If you MUST keep Server Component, wrap client animation in separate file

  // app/components/AnimatedClient.tsx
  'use client';

  import { useRef } from 'react';
  import gsap from 'gsap';
  import { useGSAP } from '@gsap/react';

  export function AnimatedClient({ children }) {
    const container = useRef();

    useGSAP(() => {
      gsap.from('.child', { opacity: 0, y: 50, stagger: 0.2 });
    }, { scope: container });

    return <div ref={container}>{children}</div>;
  }

  // app/page.tsx (Server Component)
  import { AnimatedClient } from './components/AnimatedClient';

  export default function Page() {
    return (
      <AnimatedClient>
        <div className="child">Server-rendered content</div>
        <div className="child">Animated on client</div>
      </AnimatedClient>
    );
  }

created_date: "2025-11-03"
tags: ["nextjs", "nextjs-15", "app-router", "ssr", "hydration", "react-19", "usegsap", "server-components"]
framework: "nextjs"
use_cases:
  - "Next.js 15 App Router projects"
  - "Server-side rendered GSAP animations"
  - "React 19 + GSAP integration"
  - "Avoiding hydration errors"
  - "Production Next.js apps"
why_premium: "SSR-safe GSAP initialization is ESSENTIAL for Next.js 15 production apps. Prevents hydration errors, flicker, and window is undefined errors. Foundation pattern for all Next.js GSAP work."
